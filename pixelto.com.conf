# pixelto.com.conf
# 部署拓扑：Cloudflare -> 宿主机 Nginx -> Docker 容器(Next.js Web)
# 说明：
# - 容器建议通过 docker network 暴露为 web:3000（或按你的实际容器名/地址调整 upstream）
# - /_next/image 需要缓存且必须保留 query string（w/q/url 都在 query 里）

# 如需还原用户真实 IP（可选，但建议）：
# - 建议在 /etc/nginx/conf.d/cloudflare-realip.conf 里维护 Cloudflare IP 段
# - 然后在此处 include 该文件
# include /etc/nginx/conf.d/cloudflare-realip.conf;

# 图片派生图缓存目录（宿主机持久化）
proxy_cache_path /var/cache/nginx/pixelto_next_image
  levels=1:2
  keys_zone=PIXELTO_NEXT_IMAGE:200m
  max_size=20g
  inactive=30d
  use_temp_path=off;

upstream pixelto_nextjs {
  # 方式 1：同机 docker compose/network
  # server web:3000;

  # 方式 2：容器端口映射到宿主机
  server 127.0.0.1:3000;
  keepalive 32;
}

map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  listen 80;
  server_name pixelto.com www.pixelto.com;

  # 如果你使用 HTTPS（强烈建议），把 80 重定向到 443
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name pixelto.com www.pixelto.com;

  # 这里填你的证书路径（Cloudflare Origin Cert 或 Let's Encrypt）
  ssl_certificate     /etc/nginx/cert/pixelto.com/fullchain.pem;
  ssl_certificate_key /etc/nginx/cert/pixelto.com/privkey.pem;

  # 基础安全项（可按需扩展）
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy strict-origin-when-cross-origin always;

  # 如果你希望 Nginx 识别 CF 的真实客户端 IP（可选）
  real_ip_header CF-Connecting-IP;
  real_ip_recursive on;

  # 重要：缓存 Next Image Optimizer 输出（路线 B 核心）
  location = /_next/image {
    proxy_pass http://pixelto_nextjs;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # cache key 必须包含完整 request_uri（含 query string）
    proxy_cache PIXELTO_NEXT_IMAGE;
    proxy_cache_key "$scheme$proxy_host$request_uri";
    proxy_cache_valid 200 301 302 30d;
    proxy_cache_valid any 1m;

    # 防止并发击穿：同一个派生图只有一个请求回源生成
    proxy_cache_lock on;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;

    # 避免客户端 Cache-Control 影响反代缓存
    proxy_ignore_headers Cache-Control Expires Set-Cookie;

    add_header X-Nginx-Cache $upstream_cache_status always;
  }

  # Next 静态资源（带 hash）可以强缓存
  location ^~ /_next/static/ {
    proxy_pass http://pixelto_nextjs;

    proxy_http_version 1.1;
    proxy_set_header Host $host;

    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # public/images 等静态资源：由 Next 直出，但可以让 Nginx 强缓存响应头
  # 注意：宿主机无法直接读取容器内文件，因此这里仍然 proxy_pass
  location ^~ /images/ {
    proxy_pass http://pixelto_nextjs;

    proxy_http_version 1.1;
    proxy_set_header Host $host;

    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  location ^~ /fonts/ {
    proxy_pass http://pixelto_nextjs;

    proxy_http_version 1.1;
    proxy_set_header Host $host;

    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # Web / API（含 WebSocket 升级）
  location / {
    proxy_pass http://pixelto_nextjs;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # 可选：更大的上传（如有上传图片）
    # client_max_body_size 20m;
  }
}
