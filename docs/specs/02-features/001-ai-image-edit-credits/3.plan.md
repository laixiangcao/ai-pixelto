# AI 图片编辑接口与积分扣费 - 实施计划

## WBS
- **P1 权限与扣费安全**：owner 校验、组织成员校验、正整数扣费、错误码映射。
- **P2 模型一致性**：模型配置表、默认值与前端对齐、metadata 记录 cost/modelId。
- **P3 前端体验与状态**：全局 plan/credits store（登录接口返回并注入）、头像菜单卡片、生成前登录/余额校验、登录/注册对话框封装、LivePreview 打开时机调整。
- **P4 数据与迁移**：信用表迁移/索引、生成 Prisma Client/Zod。
- **P5 验证**：lint/build、手动路径与 UI 行为检查。

## Checklist
- [ ] owner 必须二选一，非法请求返回 400。
- [ ] 组织模式需成员校验，越权返回 403。
- [ ] 模型未开放返回 400；默认模型与前端一致。
- [ ] 额度不足返回 `INSUFFICIENT_CREDITS`。
- [ ] /ai/images/edit 返回 `{ code, message, requestId, data }`，成功 code=`SUCCESS`，错误携带业务 code 与 requestId，OpenAPI 类型同步。
- [ ] credit_transaction 表与索引存在，生成客户端同步。
- [ ] `pnpm lint`、`pnpm build` 通过。
- [ ] 布局层拉取并缓存 `plan + credits + session`，头部菜单展示计划、余额、升级入口。
- [ ] 登录接口返回 plan/credits；全局 store 更新后 UI 实时刷新。
- [ ] 登录/注册对话框单栏、无右侧装饰；标题/描述不重复；表单内链接可切换登录/注册；未登录生成时弹窗而非跳转。
- [ ] 生成前用缓存余额与模型成本做本地校验，余额不足弹出充值/升级提示，不打开 LivePreview。
- [ ] LivePreview 仅在本地校验通过且 API 成功时打开，不出现闪退。

## 验证步骤
1. `pnpm --filter database generate`、`pnpm --filter database push`。
2. `pnpm lint`、`pnpm build`。
3. 手动：
   - 未登录请求 → 提示登录。
   - 非组织成员传组织 ID → 403。
   - 余额不足 → 返回业务码并展示额度不足提示。
   - 余额充足 → 成功生成，扣费与模型成本一致，LivePreview 正常打开。
   - 登录后头部菜单展示 plan/credits，并可从菜单进入升级/退出。
   - 未登录或余额不足点击生成 → 弹窗/提示而非跳转或 LivePreview 闪退；AuthDialog 单栏且切换入口在表单内。
